#!/usr/bin/env node

var exists = require('fs').existsSync;
var Metalsmith = require('..');
var program = require('commander');
var resolve = require('path').resolve;

/**
 * Program.
 */

program
  .option('-d, --destination', 'set the destination directory')
  .option('-s, --source', 'set the source directory')
  .option('-c, --config', 'set an alternate config file')
  .parse(process.argv);

/**
 * Settings.
 */

var config = resolve(process.cwd(), program.config || 'metalsmith.json');
var json = exists(config) ? require(config) : {};
var src = program.source || json.source;
var dest = program.destination || json.destination;
var data = json.metadata;
var plugins = json.plugins;

/**
 * Metalsmith.
 */

var metalsmith = new Metalsmith(process.cwd());
if (src) metalsmith.source(src);
if (dest) metalsmith.destination(dest);
if (data) metalsmith.metadata(data);

/**
 * Plugins.
 */

for (var key in plugins) {
  var plugin;
  var opts = plugins[key];

  try {
    plugin = require(key);
  } catch (e) {
    console.error('failed to require plugin "' + key + '"');
    process.exit(1);
  }

  metalsmith.use(plugin(opts));
}

/**
 * Build.
 */

metalsmith.build(function(err){
  if (err) return console.error(err);
  console.log('built');
});